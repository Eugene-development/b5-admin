<script>
	import { onMount } from 'svelte';

	/**
	 * ProjectViewModal Component
	 *
	 * A modal component for viewing detailed project information.
	 * Provides a read-only view of all project data with proper accessibility.
	 *
	 * @param {boolean} isOpen - Controls modal visibility
	 * @param {Object} project - The project object to display
	 * @param {Function} onClose - Callback function for closing the modal
	 */
	let { isOpen = false, project = null, onClose } = $props();

	let modalElement = $state();
	let closeButtonElement = $state();
	let previousActiveElement;

	// Format date helper function
	function formatDate(dateString) {
		if (!dateString) return 'Не указана';
		return new Date(dateString).toLocaleDateString('ru-RU', {
			day: '2-digit',
			month: '2-digit',
			year: 'numeric'
		});
	}

	// Format currency helper function
	function formatCurrency(amount, currency = 'RUB') {
		if (!amount && amount !== 0) return 'Не указана';
		return new Intl.NumberFormat('ru-RU', {
			style: 'currency',
			currency: currency,
			minimumFractionDigits: 0,
			maximumFractionDigits: 0
		}).format(amount);
	}

	// Format agent rate helper function
	function formatAgentRate(rate) {
		if (!rate && rate !== 0) return 'Не указана';
		return `${rate}%`;
	}

	// Get agent display text
	function getAgentDisplay(agent) {
		if (!agent) return 'Не назначен';
		return `${agent.email} (ID: ${agent.id})`;
	}

	// Check if date is overdue
	function isOverdue(dateString) {
		if (!dateString) return false;
		return new Date(dateString) < new Date();
	}

	// Handle escape key press
	function handleKeydown(event) {
		if (event.key === 'Escape' && isOpen) {
			handleClose();
		}
	}

	// Handle backdrop click
	function handleBackdropClick(event) {
		if (event.target === event.currentTarget) {
			handleClose();
		}
	}

	// Handle backdrop keydown for accessibility
	function handleBackdropKeydown(event) {
		if (event.key === 'Enter' || event.key === ' ') {
			if (event.target === event.currentTarget) {
				event.preventDefault();
				handleClose();
			}
		}
	}

	// Handle close action
	function handleClose() {
		if (onClose) {
			onClose();
		}
	}

	// Focus management
	$effect(() => {
		if (isOpen) {
			// Store the previously focused element
			previousActiveElement = document.activeElement;

			// Focus the close button when modal opens
			setTimeout(() => {
				if (closeButtonElement) {
					closeButtonElement.focus();
				}
			}, 100);

			// Add event listener for escape key
			document.addEventListener('keydown', handleKeydown);

			// Prevent body scroll
			document.body.style.overflow = 'hidden';
		} else {
			// Remove event listener
			document.removeEventListener('keydown', handleKeydown);

			// Restore body scroll
			document.body.style.overflow = '';

			// Restore focus to previously active element
			if (previousActiveElement) {
				previousActiveElement.focus();
			}
		}

		// Cleanup on component unmount
		return () => {
			document.removeEventListener('keydown', handleKeydown);
			document.body.style.overflow = '';
		};
	});
</script>

{#if isOpen && project}
	<div
		class="animate-fade animate-duration-100 animate-ease-linear fixed inset-0 z-50 overflow-y-auto"
		bind:this={modalElement}
		onclick={handleBackdropClick}
		onkeydown={handleBackdropKeydown}
		role="button"
		tabindex="0"
		aria-label="Close modal by clicking backdrop"
	>
		<div
			class="opacity-none flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"
		>
			<!-- Backdrop -->
			<div
				class="fixed inset-0 bg-black/80 transition-opacity dark:bg-black/80"
				aria-hidden="true"
			></div>

			<!-- Modal Content -->
			<div
				class="relative mx-4 transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:mx-0 sm:my-8 sm:w-full sm:max-w-4xl sm:p-6 dark:bg-gray-800"
				role="dialog"
				aria-modal="true"
				aria-labelledby="modal-title"
				tabindex="-1"
			>
				<!-- Modal Header -->
				<div
					class="flex items-center justify-between border-b border-gray-200 pb-4 dark:border-gray-600"
				>
					<h3
						class="text-lg font-semibold leading-6 text-gray-900 dark:text-white"
						id="modal-title"
					>
						Просмотр проекта
					</h3>
					<button
						type="button"
						class="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:bg-gray-800 dark:text-gray-300 dark:hover:text-white"
						onclick={handleClose}
						bind:this={closeButtonElement}
						aria-label="Закрыть модальное окно"
					>
						<svg
							class="h-6 w-6"
							fill="none"
							viewBox="0 0 24 24"
							stroke-width="1.5"
							stroke="currentColor"
						>
							<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
						</svg>
					</button>
				</div>

				<!-- Modal content -->
				<div class="mt-6">
					<!-- Project header -->
					<div class="mb-6 flex items-start justify-between">
						<div class="min-w-0 flex-1">
							<h4 class="text-xl font-bold text-gray-900 dark:text-white">
								{project.value || project.name || 'Без названия'}
							</h4>
							{#if project.contract_name}
								<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
									Договор: {project.contract_name}
								</p>
							{/if}
						</div>
						<div class="ml-4 flex-shrink-0">
							<span
								class="inline-flex items-center rounded-full {project.is_active !== false
									? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
									: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'} px-2.5 py-0.5 text-xs font-medium"
							>
								{project.is_active !== false ? 'Активен' : 'Неактивен'}
							</span>
						</div>
					</div>

					<!-- Project details grid -->
					<div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
						<!-- Basic Information -->
						<div class="space-y-4">
							<h5 class="text-base font-semibold text-gray-900 dark:text-white">
								Основная информация:
							</h5>

							<div>
								<dt
									class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
								>
									Имя клиента
								</dt>
								<dd class="mt-1 text-sm text-gray-900 dark:text-white">
									{project.value || project.name || 'Не указано'}
								</dd>
							</div>

							<div>
								<dt
									class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
								>
									Регион
								</dt>
								<dd class="mt-1 text-sm text-gray-900 dark:text-white">
									{project.region || 'Не указан'}
								</dd>
							</div>

							<div>
								<dt
									class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
								>
									Описание
								</dt>
								<dd class="mt-1 whitespace-pre-wrap text-sm text-gray-900 dark:text-white">
									{project.description || 'Не указано'}
								</dd>
							</div>
						</div>

						<!-- Contract Information -->
						<div class="space-y-4">
							<h5 class="text-base font-semibold text-gray-900 dark:text-white">
								Информация о договоре:
							</h5>

							<div>
								<dt
									class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
								>
									Номер договора
								</dt>
								<dd class="mt-1 text-sm text-gray-900 dark:text-white">
									{project.contract_name || 'Не указан'}
								</dd>
							</div>

							<div>
								<dt
									class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
								>
									Дата заключения договора
								</dt>
								<dd class="mt-1 text-sm text-gray-900 dark:text-white">
									{formatDate(project.contract_date)}
								</dd>
							</div>

							<div>
								<dt
									class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
								>
									Сумма договора
								</dt>
								<dd class="mt-1 text-sm font-semibold text-gray-900 dark:text-white">
									{formatCurrency(project.contract_amount)}
								</dd>
							</div>

							<div>
								<dt
									class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
								>
									Планируемое завершение
								</dt>
								<dd class="mt-1 text-sm text-gray-900 dark:text-white">
									{formatDate(project.planned_completion_date)}
									{#if isOverdue(project.planned_completion_date)}
										<span
											class="ml-2 inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900 dark:text-red-200"
										>
											Просрочено
										</span>
									{/if}
								</dd>
							</div>
						</div>
					</div>

					<!-- Agent and System Information -->
					<div class="mt-6 border-t border-gray-200 pt-6 dark:border-gray-600">
						<div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
							<!-- Agent Information -->
							<div class="space-y-4">
								<h5 class="text-base font-semibold text-gray-900 dark:text-white">
									Информация об агенте:
								</h5>

								<div>
									<dt
										class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
									>
										Назначенный агент
									</dt>
									<dd class="mt-1 text-sm text-gray-900 dark:text-white">
										{#if project.agent}
											<div>{project.agent.name || project.agent.email || 'Не указано'}</div>
											{#if project.agent.email && project.agent.name}
												<div class="mt-0.5 text-xs text-gray-500 dark:text-gray-400">
													{project.agent.email}
												</div>
											{/if}
										{:else}
											Не назначен
										{/if}
									</dd>
								</div>

								<div>
									<dt
										class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
									>
										Ставка агенту
									</dt>
									<dd class="mt-1 text-sm font-semibold text-gray-900 dark:text-white">
										{formatAgentRate(project.agent_percentage)}
									</dd>
								</div>
							</div>

							<!-- System Information -->
							<div class="space-y-4">
								<h5 class="text-base font-semibold text-gray-900 dark:text-white">
									Системная информация:
								</h5>

								<div>
									<dt
										class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
									>
										Дата создания
									</dt>
									<dd class="mt-1 text-sm text-gray-900 dark:text-white">
										{formatDate(project.created_at)}
									</dd>
								</div>

								<div>
									<dt
										class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300"
									>
										Дата обновления
									</dt>
									<dd class="mt-1 text-sm text-gray-900 dark:text-white">
										{formatDate(project.updated_at)}
									</dd>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Modal footer -->
				<div class="mt-6 flex justify-end border-t border-gray-200 pt-4 dark:border-gray-600">
					<button
						type="button"
						onclick={handleClose}
						class="inline-flex justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:hover:bg-gray-600"
					>
						Закрыть
					</button>
				</div>
			</div>
		</div>
	</div>
{/if}
