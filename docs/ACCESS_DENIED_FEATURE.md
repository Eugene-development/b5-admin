# Функция блокировки доступа по статусу пользователя

## Описание

Реализована система контроля доступа на основе статуса пользователя. При успешной авторизации система проверяет статус пользователя и блокирует доступ, если статус не соответствует требованиям.

## Разрешённые статусы

Доступ к системе разрешён только пользователям со следующими статусами:
- **Клиент**
- **Агент**
- **Дизайнер**

## Поведение системы

### При логине
1. Пользователь вводит корректные учётные данные
2. Система проверяет поле `user.type`
3. Если статус не определён или не входит в список разрешённых - редирект на `/access-denied`
4. Если статус корректный - продолжается стандартный процесс авторизации

### При доступе к защищённым маршрутам
Все маршруты в группе `(protected)` автоматически проверяют статус пользователя через `createAuthLoad()`.

## Реализованные файлы

### 1. Страница блокировки доступа
**Файл:** `src/routes/access-denied/+page.svelte`

Агрессивный дизайн страницы включает:
- Пульсирующие предупреждающие элементы
- Красно-чёрная цветовая схема
- Анимированный фон с предупреждающими полосами
- Детальное описание причины блокировки
- Кнопки для выхода из системы и связи с поддержкой
- Код ошибки: `ACCESS_DENIED_403`

### 2. Layout для страницы блокировки
**Файл:** `src/routes/access-denied/+layout.js`

Позволяет доступ к странице без дополнительных проверок авторизации.

### 3. Обновлённая логика логина
**Файл:** `src/routes/(auth)/login/+page.svelte`

Добавлена проверка статуса пользователя после успешного логина:
```javascript
const userType = authState.user?.type;

if (!userType || !['Клиент', 'Агент', 'Дизайнер'].includes(userType)) {
    goto('/access-denied');
    return;
}
```

### 4. Обновлённый auth-guard
**Файл:** `src/lib/auth/auth-guard.svelte.js`

Функция `createAuthLoad()` теперь проверяет статус пользователя для всех защищённых маршрутов:
```javascript
if (requireAuth && isAuth && userData) {
    const userType = userData.type;
    if (!userType || !['Клиент', 'Агент', 'Дизайнер'].includes(userType)) {
        throw redirect(302, '/access-denied');
    }
}
```

## Структура данных пользователя

Система ожидает, что объект пользователя содержит поле `type`:

```javascript
{
    id: 1,
    name: "Иван Иванов",
    email: "ivan@example.com",
    type: "Клиент", // или "Агент", или "Дизайнер"
    email_verified: true,
    // ... другие поля
}
```

## Тестирование

### Сценарий 1: Пользователь с неопределённым статусом
1. Логин с учётными данными пользователя, у которого `type: null` или `type: undefined`
2. **Ожидаемый результат:** Редирект на `/access-denied`

### Сценарий 2: Пользователь с неразрешённым статусом
1. Логин с учётными данными пользователя, у которого `type: "Администратор"` (или любой другой, кроме разрешённых)
2. **Ожидаемый результат:** Редирект на `/access-denied`

### Сценарий 3: Пользователь с разрешённым статусом
1. Логин с учётными данными пользователя, у которого `type: "Клиент"` (или "Агент", или "Дизайнер")
2. **Ожидаемый результат:** Успешный вход в систему

### Сценарий 4: Попытка прямого доступа к защищённым маршрутам
1. Пользователь с неразрешённым статусом пытается напрямую перейти на `/dashboard`
2. **Ожидаемый результат:** Редирект на `/access-denied`

## Возможные доработки

1. **Добавление логирования:** Записывать попытки доступа с неразрешённым статусом
2. **Уведомление администратора:** Отправлять уведомление при блокировке доступа
3. **Временная блокировка:** Добавить механизм временной блокировки после нескольких попыток
4. **Кастомизация сообщений:** Разные сообщения для разных типов блокировки
5. **История блокировок:** Хранить историю блокированных попыток доступа

## Контакты поддержки

При возникновении проблем с доступом пользователи могут:
- Нажать кнопку "СВЯЗАТЬСЯ С ПОДДЕРЖКОЙ" на странице блокировки
- Отправить email на: support@b5.ru
- Выйти из системы и попробовать войти с другими учётными данными
