# Функционал обновления акций

## Описание

Реализован полный функционал редактирования акций на странице `/actions` проекта b5-admin.

## Компоненты

### 1. ActionEditModal.svelte

Модальное окно для редактирования существующих акций.

**Расположение:** `src/lib/components/ActionEditModal.svelte`

**Функциональность:**
- Форма редактирования с предзаполненными данными акции
- Валидация всех полей в реальном времени
- Проверка корректности дат (дата окончания должна быть позже даты начала)
- Выбор компании-поставщика из списка
- Переключатель активности акции
- Состояния загрузки и блокировка формы во время сохранения
- Управление фокусом и доступность (accessibility)
- Закрытие по Escape или клику вне модального окна

**Props:**
- `isOpen` (boolean) - контролирует видимость модального окна
- `action` (Object) - объект акции для редактирования
- `onSave` (Function) - callback для сохранения изменений
- `onCancel` (Function) - callback для отмены
- `isLoading` (boolean) - состояние загрузки
- `companies` (Array) - список компаний для выбора

### 2. Обновленная страница Actions

**Расположение:** `src/routes/(protected)/actions/+page.svelte`

**Изменения:**
- Добавлен импорт `ActionEditModal` и `updateAction`
- Добавлено состояние `showEditModal` для управления модальным окном редактирования
- Реализована функция `handleEditAction` - открывает модальное окно с данными акции
- Реализована функция `handleSaveUpdatedAction` - сохраняет изменения через API
- Реализована функция `handleCancelEditAction` - закрывает модальное окно
- Добавлен компонент `ActionEditModal` в разметку

### 3. API функция updateAction

**Расположение:** `src/lib/api/actions.js`

Функция уже была реализована ранее и выполняет GraphQL мутацию `updateAction`.

**Параметры:**
```javascript
{
  id: string,           // ID акции (обязательно)
  name: string,         // Название акции
  description: string,  // Описание
  start: date,          // Дата начала
  end: date,            // Дата окончания
  company_id: string,   // ID компании
  is_active: boolean    // Статус активности
}
```

## Процесс редактирования

1. Пользователь нажимает кнопку "Редактировать" в таблице акций
2. Открывается модальное окно `ActionEditModal` с предзаполненными данными
3. Пользователь вносит изменения в форму
4. Форма валидируется в реальном времени
5. При нажатии "Сохранить изменения":
   - Данные отправляются через `updateAction` API
   - Выполняется повторная попытка при ошибке (retry logic)
   - Обновляются данные на странице через `invalidateAll()`
   - Показывается уведомление об успехе
6. Модальное окно закрывается

## GraphQL мутация

```graphql
mutation UpdateAction($input: UpdateActionInput!) {
  updateAction(input: $input) {
    id
    name
    description
    start
    end
    company_id
    is_active
    created_at
    updated_at
  }
}
```

## Валидация

- **Название акции**: обязательное поле, не может быть пустым
- **Описание**: обязательное поле, не может быть пустым
- **Дата начала**: обязательное поле
- **Дата окончания**: обязательное поле, должна быть позже даты начала
- **Компания**: обязательное поле, выбор из списка
- **Активность**: опциональное поле (checkbox)

## Обработка ошибок

- Ошибки API отображаются через toast-уведомления
- Реализована логика повторных попыток (2 попытки с интервалом 1 секунда)
- При ошибке модальное окно остается открытым для исправления данных

## Доступность (Accessibility)

- Управление фокусом при открытии/закрытии модального окна
- Trap focus внутри модального окна
- ARIA-атрибуты для screen readers
- Закрытие по Escape
- Минимальная высота кнопок 44px для мобильных устройств

## Тестирование

Для тестирования функционала:

1. Откройте страницу `/actions`
2. Нажмите кнопку "Редактировать" на любой акции
3. Измените данные в форме
4. Проверьте валидацию (попробуйте оставить поля пустыми)
5. Сохраните изменения
6. Убедитесь, что данные обновились в таблице

## Связанные файлы

- `src/lib/components/ActionEditModal.svelte` - компонент модального окна
- `src/routes/(protected)/actions/+page.svelte` - страница акций
- `src/lib/api/actions.js` - API функции
- `graphql/action.graphql` - GraphQL схема (в проекте b5-api-2)
