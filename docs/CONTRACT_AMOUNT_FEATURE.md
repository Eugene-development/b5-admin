# Добавление поля "Сумма контракта"

## Описание
Добавлено поле "Сумма контракта" (contract_amount) на страницу создания и редактирования договоров `/contracts`.

## Дата реализации
7 декабря 2025

## Реализованные изменения

### 1. Frontend (b5-admin)

#### ContractAddModal.svelte
- Добавлено поле ввода "Сумма контракта (₽)"
- Тип поля: number с шагом 0.01 (для копеек)
- Минимальное значение: 0
- Поле опциональное
- Добавлена валидация: сумма должна быть положительным числом
- Поле отправляется в API только если заполнено

#### ContractEditModal.svelte
- Добавлено поле ввода "Сумма контракта (₽)"
- Тип поля: number с шагом 0.01
- Минимальное значение: 0
- Поле опциональное
- Добавлена валидация
- При загрузке контракта значение подставляется из базы данных
- Поле обновляется в API только если заполнено

#### ContractViewModal.svelte
- Добавлено отображение суммы контракта в разделе "Финансовые условия"
- Сумма отображается с форматированием в рублях (₽)
- Используется крупный шрифт для выделения суммы
- Если сумма не указана, отображается "—"

### 2. Backend (b5-api-2)

#### GraphQL Schema (contract.graphql)
Добавлено поле `contract_amount: Float` в:
- `type Contract` - для возврата данных
- `input CreateContractInput` - для создания контракта
- `input UpdateContractInput` - для обновления контракта

Правила валидации: `["nullable", "numeric", "min:0"]`

#### Model (Contract.php)
- Добавлено `contract_amount` в массив `$fillable`
- Добавлен cast `'contract_amount' => 'decimal:2'` для корректной работы с денежными значениями

### 3. База данных (b5-db-2)

Поле уже существует в базе данных:
- Миграция: `2025_11_13_120001_add_contract_amount_to_contracts_table.php`
- Тип: `decimal(15, 2)` - до 15 цифр, 2 знака после запятой
- Nullable: да
- Комментарий: "Сумма контракта"

## Использование

### Создание контракта
1. Откройте страницу `/contracts`
2. Нажмите кнопку "Добавить контракт"
3. Заполните обязательные поля (Проект, Компания, Дата, Планируемое завершение)
4. Опционально: введите сумму контракта в рублях
5. Нажмите "Создать договор"

### Редактирование контракта
1. На странице `/contracts` нажмите кнопку "Редактировать" у нужного контракта
2. Измените или добавьте сумму контракта
3. Нажмите "Сохранить изменения"

## Формат данных

- **Тип**: Decimal (число с плавающей точкой)
- **Точность**: 2 знака после запятой
- **Диапазон**: 0 до 9,999,999,999,999.99 (15 цифр всего)
- **Валюта**: Рубли (₽)
- **Nullable**: Да (поле необязательное)

## Примеры значений

- `1000000.00` - один миллион рублей
- `250000.50` - двести пятьдесят тысяч рублей 50 копеек
- `null` - сумма не указана

## Технические детали

### Валидация на фронтенде
```javascript
if (value !== '' && value !== null && value !== undefined) {
    const num = parseFloat(value);
    if (isNaN(num) || num < 0) {
        newErrors.contract_amount = 'Сумма должна быть положительным числом';
    }
}
```

### Отправка в API
```javascript
if (formData.contract_amount !== '' && formData.contract_amount !== null && formData.contract_amount !== undefined) {
    contractData.contract_amount = parseFloat(formData.contract_amount);
}
```

### GraphQL запрос создания
```graphql
mutation CreateContract($input: CreateContractInput!) {
    createContract(input: $input) {
        id
        contract_amount
        # ... другие поля
    }
}
```

### GraphQL запрос обновления
```graphql
mutation UpdateContract($input: UpdateContractInput!) {
    updateContract(input: $input) {
        id
        contract_amount
        # ... другие поля
    }
}
```

## Совместимость

- Поле полностью обратно совместимо
- Существующие контракты без суммы продолжат работать (значение `null`)
- Новые контракты могут создаваться как с суммой, так и без неё

## Тестирование

### Сценарий 1: Создание контракта с суммой
1. Создайте новый контракт
2. Укажите сумму, например: 1500000
3. Сохраните
4. Проверьте, что сумма отображается при редактировании

### Сценарий 2: Создание контракта без суммы
1. Создайте новый контракт
2. Оставьте поле суммы пустым
3. Сохраните
4. Проверьте, что контракт создан успешно

### Сценарий 3: Редактирование суммы
1. Откройте существующий контракт на редактирование
2. Измените сумму
3. Сохраните
4. Проверьте, что новая сумма сохранилась

### Сценарий 5: Просмотр суммы
1. Нажмите кнопку "Просмотр" у контракта с указанной суммой
2. В разделе "Финансовые условия" должна отображаться сумма контракта
3. Сумма должна быть отформатирована с символом рубля (₽)
4. Для контракта без суммы должен отображаться прочерк "—"

### Сценарий 4: Валидация
1. Попробуйте ввести отрицательное число
2. Должна появиться ошибка валидации
3. Попробуйте ввести текст
4. Поле должно принимать только числа

## Возможные доработки

1. **Отображение в таблице**: Добавить колонку "Сумма" в таблицу контрактов
2. **Форматирование**: Добавить форматирование суммы с разделителями тысяч (1 000 000.00)
3. **Валюта**: Добавить выбор валюты (RUB, USD, EUR)
4. **Расчёты**: Автоматический расчёт комиссий на основе суммы контракта
5. **Статистика**: Показывать общую сумму всех контрактов проекта
6. **История**: Отслеживать изменения суммы контракта

## Связанные файлы

### Frontend
- `b5-admin/src/lib/components/business-processes/contracts/ContractAddModal.svelte`
- `b5-admin/src/lib/components/business-processes/contracts/ContractEditModal.svelte`
- `b5-admin/src/lib/components/business-processes/contracts/ContractViewModal.svelte`

### Backend
- `b5-api-2/graphql/contract.graphql`
- `b5-api-2/app/Models/Contract.php`

### Database
- `b5-db-2/database/migrations/2025_11_13_120001_add_contract_amount_to_contracts_table.php`

## Примечания

- Поле использует тип `decimal` для точных денежных расчётов (избегает проблем с float)
- Значение хранится в рублях с точностью до копеек
- При отображении рекомендуется использовать форматирование для удобства чтения
