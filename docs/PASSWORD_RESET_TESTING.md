# Тестирование восстановления пароля в B5-Admin

## Быстрый старт

### 1. Запустите сервисы

**Бэкенд:**

```bash
cd b5-auth-2
php artisan serve --port=8001
```

**Фронтенд:**

```bash
cd b5-admin
npm run dev
```

### 2. Откройте страницу

```
http://localhost:5173/forgot-password
```

## Полный сценарий тестирования

### Шаг 1: Запрос на восстановление

1. Откройте `http://localhost:5173/login`
2. Нажмите "Забыли пароль?"
3. Введите email существующего администратора
4. Нажмите "Отправить ссылку"
5. Должно появиться сообщение об успешной отправке

**Ожидаемый результат:**

- ✅ Форма отправляется без ошибок
- ✅ Появляется зеленое сообщение с подтверждением
- ✅ Email отображается в сообщении

### Шаг 2: Проверка письма

**Если используется MAIL_MAILER=log:**

```bash
tail -f b5-auth-2/storage/logs/laravel.log
```

Найдите ссылку вида:

```
https://admin.bonus.band/reset-password?token=...&email=...
```

**Если используется Mailtrap:**

1. Откройте [mailtrap.io](https://mailtrap.io)
2. Перейдите в inbox
3. Откройте письмо "Восстановление пароля - BONUS5"
4. Проверьте дизайн и содержимое

**Ожидаемый результат:**

- ✅ Письмо отправлено
- ✅ Дизайн соответствует стилю BONUS5
- ✅ Ссылка содержит токен и email
- ✅ Домен в ссылке соответствует registration_domain

### Шаг 3: Сброс пароля

1. Скопируйте ссылку из письма
2. Откройте её в браузере
3. Проверьте, что email предзаполнен
4. Введите новый пароль (минимум 8 символов)
5. Подтвердите пароль
6. Нажмите "Сбросить пароль"

**Ожидаемый результат:**

- ✅ Форма открывается
- ✅ Email предзаполнен и readonly
- ✅ Валидация работает (минимум 8 символов)
- ✅ Валидация совпадения паролей работает
- ✅ После успешного сброса появляется зеленое сообщение
- ✅ Автоматический редирект на /login через 2 секунды

### Шаг 4: Вход с новым паролем

1. На странице /login введите email
2. Введите новый пароль
3. Нажмите "Войти"

**Ожидаемый результат:**

- ✅ Вход успешен
- ✅ Перенаправление в dashboard
- ✅ Старый пароль больше не работает

## Тестирование ошибок

### Некорректный email

1. Введите несуществующий email
2. Нажмите "Отправить ссылку"

**Ожидаемый результат:**

- ✅ Возвращается успешный ответ (для безопасности)
- ✅ Письмо не отправляется

### Истекший токен

1. Получите ссылку для сброса
2. Подождите более 60 минут
3. Попробуйте использовать ссылку

**Ожидаемый результат:**

- ✅ Ошибка "Токен истек"
- ✅ Предложение запросить новую ссылку

### Повторное использование токена

1. Успешно сбросьте пароль
2. Попробуйте использовать ту же ссылку снова

**Ожидаемый результат:**

- ✅ Ошибка "Недействительный или истекший токен"

### Несовпадение паролей

1. Введите пароль
2. Введите другой пароль в подтверждение
3. Попробуйте отправить форму

**Ожидаемый результат:**

- ✅ Ошибка "Пароли не совпадают"
- ✅ Форма не отправляется

### Короткий пароль

1. Введите пароль менее 8 символов
2. Попробуйте отправить форму

**Ожидаемый результат:**

- ✅ Ошибка "Пароль должен содержать минимум 8 символов"
- ✅ Форма не отправляется

### Throttling

1. Отправьте 3 запроса на forgot-password подряд
2. Попробуйте отправить 4-й запрос

**Ожидаемый результат:**

- ✅ Ошибка 429 "Слишком много запросов"
- ✅ Сообщение "Попробуйте позже"

## Проверка UI/UX

### Дизайн

- ✅ Темная тема с градиентами
- ✅ Стеклянный морфизм эффект
- ✅ Анимации при загрузке
- ✅ Плавные transitions
- ✅ Иконки в полях ввода
- ✅ Градиентные кнопки

### Адаптивность

- ✅ Корректное отображение на desktop
- ✅ Корректное отображение на tablet
- ✅ Корректное отображение на mobile
- ✅ Адаптивные отступы и размеры

### Интерактивность

- ✅ Hover эффекты на кнопках
- ✅ Focus состояния на полях
- ✅ Disabled состояния при загрузке
- ✅ Анимация shake при ошибках
- ✅ Spinner при загрузке

### Навигация

- ✅ Ссылка "Забыли пароль?" на /login
- ✅ Ссылка "Вернуться к входу" на forgot-password
- ✅ Ссылка "Вернуться к входу" на reset-password
- ✅ Автоматический редирект после успешного сброса

## Проверка безопасности

### CSRF защита

- ✅ Роуты исключены из CSRF (в bootstrap/app.php)
- ✅ Запросы проходят без 419 ошибки

### Токены

- ✅ Токен генерируется случайно (64 символа)
- ✅ Токен хешируется в БД
- ✅ Токен удаляется после использования
- ✅ Токен истекает через 60 минут

### Throttling

- ✅ Ограничение 3 запроса в минуту
- ✅ Корректная обработка 429 ошибки

### Мультидоменность

- ✅ Ссылка формируется с правильным доменом
- ✅ Fallback на FRONTEND_URL работает

## Отладка проблем

### Письмо не отправляется

```bash
# Проверьте логи
tail -f b5-auth-2/storage/logs/laravel.log

# Проверьте конфигурацию
grep MAIL_ b5-auth-2/.env

# Очистите кэш
cd b5-auth-2
php artisan config:clear
php artisan cache:clear
```

### Ошибка 419 (CSRF)

```bash
# Проверьте исключения в bootstrap/app.php
grep -A 5 "validateCsrfTokens" b5-auth-2/bootstrap/app.php

# Должно быть:
# $middleware->validateCsrfTokens(except: [
#     'api/forgot-password',
#     'api/reset-password',
# ]);
```

### Ошибка сети

```bash
# Проверьте, что бэкенд запущен
curl http://localhost:8001/api/user

# Проверьте CORS
grep -A 10 "allowed_origins" b5-auth-2/config/cors.php
```

### Неправильный домен в ссылке

```bash
# Проверьте registration_domain пользователя
cd b5-auth-2
php artisan tinker
>>> $user = User::where('email', 'admin@test.com')->first();
>>> echo $user->registration_domain;

# Проверьте FRONTEND_URL
grep FRONTEND_URL b5-auth-2/.env
```

## Чек-лист успешного тестирования

- [ ] Форма forgot-password отправляется
- [ ] Письмо приходит с правильным дизайном
- [ ] Ссылка в письме работает
- [ ] Форма reset-password открывается
- [ ] Email предзаполнен
- [ ] Валидация работает
- [ ] Новый пароль сохраняется
- [ ] Редирект на /login работает
- [ ] Вход с новым паролем успешен
- [ ] Старый пароль не работает
- [ ] Токен нельзя использовать повторно
- [ ] Истекшие токены отклоняются
- [ ] Throttling работает
- [ ] Дизайн соответствует макету
- [ ] Адаптивность работает
- [ ] Анимации плавные
- [ ] Нет ошибок в консоли

## Автоматизированное тестирование

Для автоматизации можно использовать:

```bash
# Vitest для unit тестов
npm run test

# Playwright для E2E тестов (если настроен)
npm run test:e2e
```

## Производственное тестирование

Перед деплоем на продакшен:

1. Проверьте настройки почты
2. Проверьте FRONTEND_URL для каждого домена
3. Проверьте CORS настройки
4. Проверьте SSL сертификаты
5. Проверьте throttling лимиты
6. Проверьте логирование ошибок
7. Проверьте мониторинг

## Поддержка

При возникновении проблем:

1. Проверьте логи Laravel: `b5-auth-2/storage/logs/laravel.log`
2. Проверьте консоль браузера (F12)
3. Проверьте Network tab в DevTools
4. Обратитесь к документации: `PASSWORD_RESET_FEATURE.md`
