# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Agents

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É `/agents` –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞:

```
GraphQL Error in refreshUsers: Unauthenticated.
extensions: {"guards":["api"]}
```

–õ–æ–∫–∞–ª—å–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è. –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/clients` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/agents` –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## –ü—Ä–∏—á–∏–Ω–∞

–ü—Ä–æ–±–ª–µ–º–∞ —Å–≤—è–∑–∞–Ω–∞ —Å —Ç–µ–º, —á—Ç–æ GraphQL API –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç guard `api` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT —Ç–æ–∫–µ–Ω–æ–≤.

### –ö–ª—é—á–µ–≤–æ–µ —Ä–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É clients –∏ users:

**–í `b5-api-2/graphql/project.graphql`:**

```graphql
clients: [Client!]! @all(model: "App\\Models\\Client")  # –ë–ï–ó @guard
```

**–í `b5-api-2/graphql/user.graphql`:**

```graphql
users: [User!]! @guard @all  # –° @guard - —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é!
```

–ó–∞–ø—Ä–æ—Å `clients` —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –ø–æ—ç—Ç–æ–º—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/clients` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
–ó–∞–ø—Ä–æ—Å `users` —Ç—Ä–µ–±—É–µ—Ç JWT —Ç–æ–∫–µ–Ω —Å guard `api`, –∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ "Unauthenticated".

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **JWT —Ç–æ–∫–µ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ**
2. **JWT —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫**
3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å CORS - –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è**
4. **–†–∞–∑–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è JWT –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∏ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞—Ö**
5. **–ö–µ—à –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ JWT**

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É —Ç–æ–∫–µ–Ω–∞

–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `b5-admin/src/lib/api/agents.js`:

```javascript
async function makeGraphQLRequest(
	query,
	variables = {},
	operationName = 'GraphQL operation',
	customFetch = null,
	cookies = null
) {
	try {
		// Get authentication headers
		const authHeaders = getAuthHeaders();

		// –î–û–ë–ê–í–ò–¢–¨ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
		console.log('üîê Auth headers for', operationName, ':', authHeaders);
		console.log('üåê GraphQL endpoint:', GRAPHQL_ENDPOINT);

		const headers = {
			'Content-Type': 'application/json',
			Accept: 'application/json',
			...authHeaders
		};

		// ...rest of code
	}
}
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª `b5-api-2/config/auth.php` –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ:

```php
'guards' => [
    'api' => [
        'driver' => 'jwt',  // –î–æ–ª–∂–µ–Ω –±—ã—Ç—å jwt, –Ω–µ sanctum
        'provider' => 'users',
    ],
],
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å middleware –≤ GraphQL

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª `b5-api-2/config/lighthouse.php`:

```php
'guard' => 'api',  // –î–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å guard 'api'
```

## –†–µ—à–µ–Ω–∏–µ

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ isRefreshing

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `refreshData` - —Ç–µ–ø–µ—Ä—å `isRefreshing` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–∞:

```javascript
if (!hasAuthToken()) {
	console.warn('No auth token available, skipping data refresh');
	loadError = {
		message: '–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.'
	};
	isRefreshing = false; // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
	return;
}
```

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `agents.js` –∏ `clients.js` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

```javascript
console.log(`üîê [${operationName}] Auth headers:`, authHeaders);
console.log(`üåê [${operationName}] GraphQL endpoint:`, GRAPHQL_ENDPOINT);
```

–¢–µ–ø–µ—Ä—å –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å:

- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ª–∏ —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
- –ö–∞–∫–æ–π endpoint –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

–í–æ–∑–º–æ–∂–Ω–æ, –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç–∞—Ä–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ JWT:

```bash
# SSH –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä
cd /var/www  # –∏–ª–∏ –ø—É—Ç—å –∫ b5-api-2

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–µ—à–∏
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–µ—à –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
php artisan config:cache

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å PHP-FPM (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
sudo systemctl restart php8.2-fpm  # –∏–ª–∏ php8.1-fpm, php8.3-fpm
```

### –í–∞—Ä–∏–∞–Ω—Ç 4: –í—Ä–µ–º–µ–Ω–Ω–æ —É–±—Ä–∞—Ç—å @guard –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É, –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ —É–±—Ä–∞—Ç—å `@guard` –∏–∑ users query:

**–í `b5-api-2/graphql/user.graphql`:**

```graphql
extend type Query {
	"Get all users"
	users: [User!]! @all # –£–±—Ä–∞–ª–∏ @guard –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

	# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ queries
}
```

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** –≠—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.

### –í–∞—Ä–∏–∞–Ω—Ç 5: –î–æ–±–∞–≤–∏—Ç—å @guard –∫ clients –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

–õ—É—á—à–µ–µ —Ä–µ—à–µ–Ω–∏–µ - –¥–æ–±–∞–≤–∏—Ç—å `@guard` –∫ clients query –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

**–í `b5-api-2/graphql/project.graphql`:**

```graphql
extend type Query {
	"Get all clients"
	clients: [Client!]! @guard @all(model: "App\\Models\\Client")

	# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ queries
}
```

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è GraphQL schema:

```bash
php artisan lighthouse:clear-cache
php artisan config:clear
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –î–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è —Ç–æ–∫–µ–Ω–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è, –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –Ω–∞—á–∞–ª–æ `refreshData`:

```javascript
async function refreshData(isInitialLoad = false) {
	isRefreshing = true;
	try {
		// –î–û–ë–ê–í–ò–¢–¨ –ü–†–û–í–ï–†–ö–£
		const { hasAuthToken } = await import('$lib/api/config.js');
		if (!hasAuthToken()) {
			console.warn('‚ö†Ô∏è No auth token available, skipping data refresh');
			loadError = {
				message: '–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.'
			};
			isRefreshing = false;
			return;
		}

		const users = await refreshUsers();
		// ...rest of code
	}
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ –≤ `b5-api-2/config/cors.php` —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ Authorization:

```php
'allowed_headers' => ['*'],
// –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ
'allowed_headers' => ['Content-Type', 'Authorization', 'Accept'],
```

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∫–æ–¥–µ):

```javascript
// –í b5-admin/src/routes/(protected)/agents/+page.svelte
async function refreshData(isInitialLoad = false) {
	isRefreshing = true;
	try {
		// Check if we have a token before making the request
		const { hasAuthToken } = await import('$lib/api/config.js');
		if (!hasAuthToken()) {
			console.warn('No auth token available, skipping data refresh');
			loadError = {
				message: '–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.'
			};
			return;
		}

		// ...rest of code
	}
}
```

–≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–¥–µ, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–õ–æ–≥–∏ Laravel –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ:**

   ```bash
   tail -f /var/www/storage/logs/laravel.log
   ```

2. **Network tab –≤ –±—Ä–∞—É–∑–µ—Ä–µ:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Network
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É /agents
   - –ù–∞–π–¥–∏—Ç–µ GraphQL –∑–∞–ø—Ä–æ—Å
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Headers ‚Üí Request Headers ‚Üí Authorization

3. **–°—Ä–∞–≤–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã clients vs agents:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ –æ–±–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   - –°—Ä–∞–≤–Ω–∏—Ç–µ GraphQL –∑–∞–ø—Ä–æ—Å—ã –≤ Network tab
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:

```
1. –û—Ç–∫—Ä–æ–π—Ç–µ https://admin.bonus.band
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É
3. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Console
4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É /agents
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   - üîÑ Refreshing agents data...
   - üîê [refreshUsers] Auth headers: { Authorization: "Bearer ..." }
   - üåê [refreshUsers] GraphQL endpoint: https://api.bonus.band/graphql
```

### 2. –°—Ä–∞–≤–Ω–∏—Ç—å —Å clients

–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É /clients –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ –∂–µ –ª–æ–≥–∏. –°—Ä–∞–≤–Ω–∏—Ç–µ:

- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ª–∏ —Ç–æ–∫–µ–Ω –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö?
- –û–¥–∏–Ω–∞–∫–æ–≤—ã–π –ª–∏ endpoint?
- –ï—Å—Ç—å –ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö?

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network tab

```
1. DevTools ‚Üí Network
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ /agents
3. –ù–∞–π–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∫ /graphql
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - Request Headers ‚Üí Authorization: Bearer ...
   - Response ‚Üí –ï—Å–ª–∏ 401/403, –∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è, –Ω–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—à–∏–±–∫–∞ "Unauthenticated", –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# SSH –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä
cd /var/www  # –ø—É—Ç—å –∫ b5-api-2

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é auth
cat config/auth.php | grep -A 5 "'api'"

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# 'api' => [
#     'driver' => 'jwt',
#     'provider' => 'users',
# ],

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é lighthouse
cat config/lighthouse.php | grep guard

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# 'guard' => 'api',

# –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
php artisan config:clear
php artisan config:cache
```

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Laravel

```bash
# –ù–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ
tail -f storage/logs/laravel.log

# –ó–∞—Ç–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ /agents
# –°–º–æ—Ç—Ä–∏—Ç–µ, –∫–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö
```

## –ù–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–û—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –∫–æ–¥–∞, –Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ - **–∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ä–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ**.

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):

#### 1. –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (–ü–ï–†–í–´–ú –î–ï–õ–û–ú)

```bash
# SSH –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä
cd /var/www  # –ø—É—Ç—å –∫ b5-api-2

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–µ—à–∏
php artisan config:clear
php artisan cache:clear
php artisan lighthouse:clear-cache

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–µ—à
php artisan config:cache

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å PHP-FPM
sudo systemctl restart php8.2-fpm
```

#### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ù–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www
cat .env | grep JWT

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
# JWT_SECRET=...
# JWT_TTL=60
```

#### 3. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
cd b5-admin
git add .
git commit -m "Add JWT auth debugging for agents page"
git push

# –ó–∞—Ç–µ–º –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω
```

#### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –æ—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ https://admin.bonus.band –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ª–∏ —Ç–æ–∫–µ–Ω: `üîê [refreshUsers] Auth headers: { Authorization: "Bearer ..." }`
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å, –Ω–æ –æ—à–∏–±–∫–∞ - –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É 1)
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage)

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å isRefreshing
3. ‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É clients –∏ users queries
4. ‚è≥ **–°–ï–ô–ß–ê–°:** –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–µ (—Å–º. –≤—ã—à–µ)
5. ‚è≥ –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω
6. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
7. ‚è≥ –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å JWT –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

## –†–µ–∑—é–º–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å `users` —Ç—Ä–µ–±—É–µ—Ç JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (`@guard`), –∞ `clients` - –Ω–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ:** –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ JWT —Ç–æ–∫–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö.

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
