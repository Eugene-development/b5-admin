# Changelog: Редактирование и удаление выплат

## Дата: 2026-01-15

### Добавлено

#### Frontend (b5-admin)

**Новые компоненты:**
- `src/lib/components/finances/PaymentEditModal.svelte` - модальное окно для редактирования заявки на выплату
- `src/lib/components/finances/PaymentDeleteModal.svelte` - модальное окно для подтверждения удаления заявки

**API функции:**
- `updateBonusPaymentRequest(requestId, input)` - обновление заявки на выплату
- `deleteBonusPaymentRequest(requestId)` - удаление заявки на выплату

**Обновленные компоненты:**
- `src/lib/components/finances/PaymentsTable.svelte`:
  - Добавлены кнопки "Редактировать" и "Удалить" в таблицу
  - Добавлены обработчики для редактирования и удаления
  - Добавлены props `onPaymentUpdate` и `onPaymentDelete`

- `src/routes/(protected)/(finances)/payments/+page.svelte`:
  - Добавлены обработчики `handlePaymentUpdate()` и `handlePaymentDelete()`
  - Обновление локального состояния при изменении/удалении заявок

#### Backend (b5-api-2)

**GraphQL схема:**
- Добавлен input тип `UpdateBonusPaymentRequestInput`
- Добавлена мутация `updateBonusPaymentRequest`
- Добавлена мутация `deleteBonusPaymentRequest`

**Resolvers:**
- `app/GraphQL/Mutations/UpdateBonusPaymentRequest.php` - обработка обновления заявки
- `app/GraphQL/Mutations/DeleteBonusPaymentRequest.php` - обработка удаления заявки

#### Документация

- `docs/PAYMENT_EDIT_DELETE_FEATURE.md` - техническая документация функционала
- `docs/PAYMENT_MANAGEMENT_GUIDE.md` - руководство пользователя
- `docs/PAYMENT_EDIT_DELETE_CHANGELOG.md` - список изменений

### Функциональность

**Редактирование выплаты:**
- Изменение суммы выплаты (минимум 1 000 ₽)
- Изменение способа выплаты (Карта, СБП, Другое)
- Изменение реквизитов в зависимости от способа
- Изменение комментария
- Валидация на frontend и backend
- Ограничение: нельзя редактировать выплаченные и отмененные заявки

**Удаление выплаты:**
- Подтверждение удаления через модальное окно
- Отображение информации о заявке перед удалением
- Транзакционное удаление с очисткой связанных данных
- Ограничение: нельзя удалить выплаченные заявки

**Безопасность:**
- Операции выполняются через GraphQL API
- Валидация на всех уровнях
- Защита от удаления/редактирования критичных заявок
- Рекомендуется настроить проверку прав доступа на уровне middleware

### UI/UX улучшения

- Добавлены иконки для кнопок действий
- Цветовая дифференциация кнопок (синий - редактирование, красный - удаление)
- Toast-уведомления об успешных операциях
- Информативные сообщения об ошибках
- Адаптивный дизайн для мобильных устройств
- Accessibility: aria-labels для всех кнопок

### Технические детали

**Обновление состояния:**
- Локальное обновление списка заявок без перезагрузки страницы
- Инкремент счетчика обновлений для реактивности
- Сохранение текущей страницы пагинации

**Валидация:**
- Минимальная сумма: 1 000 ₽
- Обязательные реквизиты в зависимости от способа оплаты
- Проверка статуса перед редактированием/удалением

**Обработка ошибок:**
- Graceful error handling с понятными сообщениями
- Блокировка UI во время выполнения операций
- Откат изменений при ошибках

## Совместимость

- Совместимо с существующим функционалом выплат
- Не требует миграций базы данных
- Обратная совместимость с API сохранена

## Тестирование

Рекомендуется протестировать:
1. Редактирование заявки в статусе "Новая"
2. Попытку редактирования выплаченной заявки (должна быть заблокирована)
3. Удаление заявки в статусе "В обработке"
4. Попытку удаления выплаченной заявки (должна быть заблокирована)
5. Валидацию суммы (меньше 1000 ₽)
6. Смену способа оплаты и автоматическую очистку реквизитов
7. Работу на мобильных устройствах
