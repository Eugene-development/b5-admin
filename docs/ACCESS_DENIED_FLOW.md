# Схема работы системы блокировки доступа

## Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                            │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
                    ┌────────────────┐
                    │  Страница      │
                    │  /login        │
                    └────────┬───────┘
                             │
                             ▼
                    ┌────────────────┐
                    │  Ввод email    │
                    │  и пароля      │
                    └────────┬───────┘
                             │
                             ▼
                    ┌────────────────┐
                    │  Отправка      │
                    │  на API        │
                    └────────┬───────┘
                             │
                ┌────────────┴────────────┐
                │                         │
                ▼                         ▼
        ┌───────────────┐         ┌──────────────┐
        │  Ошибка 401   │         │  Успех 200   │
        │  Неверные     │         │  Получен     │
        │  данные       │         │  токен       │
        └───────┬───────┘         └──────┬───────┘
                │                        │
                ▼                        ▼
        ┌───────────────┐         ┌──────────────┐
        │  Показать     │         │  Проверка    │
        │  ошибку       │         │  user.type   │
        └───────────────┘         └──────┬───────┘
                                         │
                        ┌────────────────┼────────────────┐
                        │                │                │
                        ▼                ▼                ▼
                ┌───────────────┐ ┌──────────┐ ┌─────────────┐
                │  type: null   │ │  type:   │ │  type:      │
                │  или          │ │  "Адми-  │ │  "Клиент"   │
                │  undefined    │ │  нистра- │ │  "Агент"    │
                │               │ │  тор"    │ │  "Дизайнер" │
                └───────┬───────┘ └────┬─────┘ └──────┬──────┘
                        │              │               │
                        └──────┬───────┘               │
                               │                       │
                               ▼                       ▼
                    ┌──────────────────┐      ┌───────────────┐
                    │  Редирект на     │      │  Проверка     │
                    │  /access-denied  │      │  email_       │
                    └──────────────────┘      │  verified     │
                                              └───────┬───────┘
                                                      │
                                        ┌─────────────┼─────────────┐
                                        │                           │
                                        ▼                           ▼
                                ┌───────────────┐         ┌─────────────┐
                                │  email_       │         │  email_     │
                                │  verified:    │         │  verified:  │
                                │  false        │         │  true       │
                                └───────┬───────┘         └──────┬──────┘
                                        │                        │
                                        ▼                        ▼
                                ┌───────────────┐         ┌─────────────┐
                                │  Редирект на  │         │  Редирект   │
                                │  /email-      │         │  на         │
                                │  verify       │         │  /dashboard │
                                └───────────────┘         └─────────────┘
```

## Детальная схема проверки статуса

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПРОВЕРКА СТАТУСА ПОЛЬЗОВАТЕЛЯ                │
└─────────────────────────────────────────────────────────────────┘

                        ┌──────────────────┐
                        │  authState.user  │
                        └────────┬─────────┘
                                 │
                                 ▼
                        ┌──────────────────┐
                        │  Получить        │
                        │  user.type       │
                        └────────┬─────────┘
                                 │
                                 ▼
                        ┌──────────────────┐
                        │  user.type       │
                        │  существует?     │
                        └────────┬─────────┘
                                 │
                    ┌────────────┼────────────┐
                    │                         │
                    ▼ НЕТ                     ▼ ДА
            ┌───────────────┐         ┌──────────────┐
            │  ❌ БЛОКИРОВКА │         │  Проверить   │
            │  Статус не    │         │  в списке    │
            │  определён    │         │  разрешённых │
            └───────┬───────┘         └──────┬───────┘
                    │                        │
                    │         ┌──────────────┼──────────────┐
                    │         │                             │
                    │         ▼ НЕТ                         ▼ ДА
                    │  ┌──────────────┐             ┌──────────────┐
                    │  │  ❌ БЛОКИРОВКА│             │  ✅ ДОСТУП   │
                    │  │  Неразрешённый│             │  РАЗРЕШЁН    │
                    │  │  статус       │             └──────────────┘
                    │  └──────┬───────┘
                    │         │
                    └─────────┼─────────┐
                              │         │
                              ▼         ▼
                    ┌──────────────────────────┐
                    │  Редирект на             │
                    │  /access-denied          │
                    └──────────────────────────┘
```

## Схема страницы /access-denied

```
┌─────────────────────────────────────────────────────────────────┐
│                      СТРАНИЦА /access-denied                    │
└─────────────────────────────────────────────────────────────────┘

                    ┌──────────────────────┐
                    │  Пользователь        │
                    │  попадает на         │
                    │  /access-denied      │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │  Отображение:        │
                    │  • Иконка ⚠️         │
                    │  • Заголовок         │
                    │  • Описание          │
                    │  • Причина           │
                    │  • Требования        │
                    │  • Действия          │
                    │  • Кнопки            │
                    └──────────┬───────────┘
                               │
                ┌──────────────┼──────────────┐
                │                             │
                ▼                             ▼
    ┌───────────────────┐         ┌──────────────────┐
    │  Кнопка:          │         │  Кнопка:         │
    │  "ВЫЙТИ ИЗ        │         │  "СВЯЗАТЬСЯ С    │
    │  СИСТЕМЫ"         │         │  ПОДДЕРЖКОЙ"     │
    └─────────┬─────────┘         └────────┬─────────┘
              │                            │
              ▼                            ▼
    ┌───────────────────┐         ┌──────────────────┐
    │  Вызов logout()   │         │  Открыть         │
    │  Очистка токенов  │         │  mailto:         │
    │  Редирект на      │         │  support@b5.ru   │
    │  /login           │         └──────────────────┘
    └───────────────────┘
```

## Схема защиты маршрутов

```
┌─────────────────────────────────────────────────────────────────┐
│                    ЗАЩИТА МАРШРУТОВ (protected)                 │
└─────────────────────────────────────────────────────────────────┘

                    ┌──────────────────────┐
                    │  Пользователь        │
                    │  переходит на        │
                    │  /dashboard          │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │  Вызов               │
                    │  createAuthLoad()    │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │  Проверка            │
                    │  isAuthenticated     │
                    └──────────┬───────────┘
                               │
                ┌──────────────┼──────────────┐
                │                             │
                ▼ НЕТ                         ▼ ДА
    ┌───────────────────┐         ┌──────────────────┐
    │  Редирект на      │         │  Проверка        │
    │  /login           │         │  user.type       │
    └───────────────────┘         └────────┬─────────┘
                                           │
                            ┌──────────────┼──────────────┐
                            │                             │
                            ▼ НЕРАЗРЕШЁН                  ▼ РАЗРЕШЁН
                ┌───────────────────┐         ┌──────────────────┐
                │  Редирект на      │         │  Проверка        │
                │  /access-denied   │         │  email_verified  │
                └───────────────────┘         └────────┬─────────┘
                                                       │
                                        ┌──────────────┼──────────────┐
                                        │                             │
                                        ▼ НЕТ                         ▼ ДА
                            ┌───────────────────┐         ┌──────────────────┐
                            │  Редирект на      │         │  ✅ ДОСТУП К     │
                            │  /email-verify    │         │  СТРАНИЦЕ        │
                            └───────────────────┘         └──────────────────┘
```

## Схема хранения данных

```
┌─────────────────────────────────────────────────────────────────┐
│                    ХРАНЕНИЕ ДАННЫХ ПОЛЬЗОВАТЕЛЯ                 │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────┐
    │                    localStorage                      │
    ├──────────────────────────────────────────────────────┤
    │                                                      │
    │  b5_admin_auth_token:                               │
    │  {                                                   │
    │    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",   │
    │    "token_type": "Bearer",                          │
    │    "expires_at": "2024-01-02T00:00:00Z"            │
    │  }                                                   │
    │                                                      │
    │  b5_admin_user_data:                                │
    │  {                                                   │
    │    "id": 1,                                         │
    │    "name": "Иван Иванов",                          │
    │    "email": "ivan@example.com",                    │
    │    "type": "Клиент",          ◄─── ВАЖНОЕ ПОЛЕ    │
    │    "email_verified": true,                         │
    │    "email_verified_at": "2024-01-01T00:00:00Z"    │
    │  }                                                   │
    │                                                      │
    └──────────────────────────────────────────────────────┘
                             │
                             ▼
    ┌──────────────────────────────────────────────────────┐
    │                    authState (Svelte)                │
    ├──────────────────────────────────────────────────────┤
    │                                                      │
    │  user: { ... }                                      │
    │  isAuthenticated: true                              │
    │  emailVerified: true                                │
    │  token: "eyJ0eXAiOiJKV1QiLCJhbGc..."               │
    │  initialized: true                                  │
    │                                                      │
    └──────────────────────────────────────────────────────┘
```

## Схема взаимодействия с API

```
┌─────────────────────────────────────────────────────────────────┐
│                    ВЗАИМОДЕЙСТВИЕ С API                         │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐                           ┌──────────────┐
    │   Frontend   │                           │   Backend    │
    │   (Svelte)   │                           │   (Laravel)  │
    └──────┬───────┘                           └──────┬───────┘
           │                                          │
           │  POST /api/login                         │
           │  { email, password }                     │
           ├─────────────────────────────────────────►│
           │                                          │
           │                                          │  Проверка
           │                                          │  credentials
           │                                          │
           │  200 OK                                  │
           │  {                                       │
           │    "user": {                             │
           │      "type": "Клиент"  ◄─── ВАЖНО       │
           │    },                                    │
           │    "token": { ... }                      │
           │  }                                       │
           │◄─────────────────────────────────────────┤
           │                                          │
           │  Сохранение в localStorage               │
           │  Проверка user.type                      │
           │                                          │
           │  ┌─────────────────┐                     │
           │  │ type разрешён?  │                     │
           │  └────────┬────────┘                     │
           │           │                              │
           │  ┌────────┼────────┐                     │
           │  │                 │                     │
           │  ▼ ДА              ▼ НЕТ                 │
           │  /dashboard        /access-denied        │
           │                                          │
```

## Схема обработки ошибок

```
┌─────────────────────────────────────────────────────────────────┐
│                    ОБРАБОТКА ОШИБОК                             │
└─────────────────────────────────────────────────────────────────┘

                    ┌──────────────────────┐
                    │  Попытка доступа     │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │  Проверка статуса    │
                    └──────────┬───────────┘
                               │
                ┌──────────────┼──────────────┐
                │                             │
                ▼ ОШИБКА                      ▼ УСПЕХ
    ┌───────────────────────┐     ┌──────────────────┐
    │  Определить тип       │     │  Продолжить      │
    │  ошибки:              │     │  выполнение      │
    │  • type = null        │     └──────────────────┘
    │  • type = undefined   │
    │  • type неразрешён    │
    └─────────┬─────────────┘
              │
              ▼
    ┌───────────────────────┐
    │  Логирование:         │
    │  • User ID            │
    │  • Email              │
    │  • Type               │
    │  • Timestamp          │
    │  • User Agent         │
    └─────────┬─────────────┘
              │
              ▼
    ┌───────────────────────┐
    │  Уведомление:         │
    │  • Администратор      │
    │  • Telegram           │
    │  • Email              │
    └─────────┬─────────────┘
              │
              ▼
    ┌───────────────────────┐
    │  Редирект на          │
    │  /access-denied       │
    └───────────────────────┘
```

## Временная диаграмма

```
Время →

Пользователь    Frontend         Auth Guard       Backend
    │               │                 │               │
    │  Открыть      │                 │               │
    │  /login       │                 │               │
    ├──────────────►│                 │               │
    │               │                 │               │
    │  Ввести       │                 │               │
    │  данные       │                 │               │
    ├──────────────►│                 │               │
    │               │                 │               │
    │               │  POST /api/login│               │
    │               ├─────────────────┼──────────────►│
    │               │                 │               │
    │               │                 │  Проверка     │
    │               │                 │  credentials  │
    │               │                 │               │
    │               │  200 OK + user  │               │
    │               │◄────────────────┼───────────────┤
    │               │                 │               │
    │               │  Проверка       │               │
    │               │  user.type      │               │
    │               │                 │               │
    │               │  ┌──────────┐   │               │
    │               │  │ Разрешён?│   │               │
    │               │  └────┬─────┘   │               │
    │               │       │         │               │
    │               │  ┌────┼────┐    │               │
    │               │  │         │    │               │
    │               │  ▼ ДА      ▼ НЕТ│               │
    │               │  /dashboard     │               │
    │               │  /access-denied │               │
    │               │                 │               │
    │  Показать     │                 │               │
    │  страницу     │                 │               │
    │◄──────────────┤                 │               │
    │               │                 │               │
    ▼               ▼                 ▼               ▼
```

## Схема мониторинга

```
┌─────────────────────────────────────────────────────────────────┐
│                    МОНИТОРИНГ СИСТЕМЫ                           │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────┐
    │                  События системы                     │
    └────────────────────┬─────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │ Успешный│    │ Блокиро-│    │ Попытка │
    │ вход    │    │ вка     │    │ обхода  │
    └────┬────┘    └────┬────┘    └────┬────┘
         │              │              │
         └──────┬───────┴──────┬───────┘
                │              │
                ▼              ▼
    ┌──────────────────────────────────┐
    │         Логирование              │
    │  • Timestamp                     │
    │  • User ID                       │
    │  • Event Type                    │
    │  • User Type                     │
    │  • IP Address                    │
    │  • User Agent                    │
    └────────────┬─────────────────────┘
                 │
                 ▼
    ┌──────────────────────────────────┐
    │         Аналитика                │
    │  • Количество блокировок         │
    │  • Типы заблокированных          │
    │  • Время пиковой нагрузки        │
    │  • Обращения в поддержку         │
    └────────────┬─────────────────────┘
                 │
                 ▼
    ┌──────────────────────────────────┐
    │         Уведомления              │
    │  • Email администратору          │
    │  • Telegram бот                  │
    │  • Dashboard метрики             │
    └──────────────────────────────────┘
```

## Заключение

Эти схемы помогают понять:

- 🔄 Полный цикл проверки доступа
- 🔒 Точки безопасности
- 📊 Поток данных
- ⚠️ Обработку ошибок
- 📈 Мониторинг системы

Для получения дополнительной информации см.:

- `docs/ACCESS_DENIED_FEATURE.md` - Полное описание
- `docs/ACCESS_DENIED_CODE_EXAMPLES.md` - Примеры кода
- `test-access-denied.md` - Тестирование
