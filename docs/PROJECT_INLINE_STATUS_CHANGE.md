# Inline смена статусов проектов

## Дата: 15 декабря 2025

## Описание

Реализован функционал смены статусов проектов непосредственно в таблице проектов, без необходимости открывать модальное окно редактирования. Функционал аналогичен реализации на странице `/finances`.

## Изменения

### 1. Новый компонент `ProjectStatusBadge`

**Файл:** `b5-admin/src/lib/components/business-processes/projects/ProjectStatusBadge.svelte`

Компонент отображает текущий статус проекта в виде бейджа с выпадающим списком для быстрой смены статуса.

**Особенности:**
- Dropdown меню со списком всех доступных статусов
- Визуальная индикация текущего статуса (цветовое кодирование)
- Индикатор загрузки при обновлении статуса
- Автоматическое закрытие при клике вне компонента
- Поддержка readonly режима

**Цветовая схема статусов:**
- `new-project` (Новый проект) - изумрудный
- `curator-processing` (Принят куратором) - синий
- `in-progress` (В работе) - жёлтый
- `completed` (Завершён) - зелёный
- `cancelled` (Отменён) - красный

### 2. Обновлён компонент `ProjectsTable`

**Файл:** `b5-admin/src/lib/components/business-processes/projects/ProjectsTable.svelte`

**Изменения:**
- Заменён `StatusBadge` на `ProjectStatusBadge` в колонке "Статус"
- Добавлен prop `projectStatuses` для передачи списка статусов
- Добавлен prop `onStatusChange` для обработки изменения статуса
- Обновлены desktop, mobile и tablet версии таблицы

### 3. Обновлена страница проектов

**Файл:** `b5-admin/src/routes/(protected)/(business-processes)/projects/+page.svelte`

**Изменения:**
- Добавлена функция `handleStatusChange` для обработки inline смены статуса
- Передача `projectStatuses` и `onStatusChange` в компонент `ProjectsTable`
- Автоматическое обновление счётчика новых проектов в сайдбаре при смене статуса

### 4. Обновлён экспорт компонентов

**Файл:** `b5-admin/src/lib/index.js`

Добавлен экспорт нового компонента `ProjectStatusBadge`.

## Использование

### В таблице проектов

```svelte
<ProjectsTable
  projects={paginatedProjects}
  projectStatuses={projectStatuses}
  onStatusChange={handleStatusChange}
  ...
/>
```

### Обработчик изменения статуса

```javascript
async function handleStatusChange(updatedProject) {
  try {
    // Обновить локальное состояние
    updateProjectInList(updatedProject);
    // Обновить счётчик новых проектов
    await newProjectsState.refresh();
  } catch (error) {
    console.error('Failed to handle status change:', error);
  }
}
```

## API

### ProjectStatusBadge Props

| Prop | Тип | Обязательный | Описание |
|------|-----|--------------|----------|
| `project` | Object | Да | Объект проекта со свойством `status` |
| `projectStatuses` | Array | Да | Массив доступных статусов проектов |
| `onStatusChange` | Function | Нет | Callback при успешной смене статуса |
| `readonly` | Boolean | Нет | Режим только для чтения (без dropdown) |

### Формат объекта статуса

```javascript
{
  id: "01K7HRKV20QE6K37YY18D206NQ",
  slug: "curator-processing",
  value: "Принят куратором",
  sort_order: 2,
  is_default: false
}
```

## Преимущества

1. **Быстрота** - смена статуса в один клик без открытия модального окна
2. **UX** - интуитивно понятный интерфейс с визуальной обратной связью
3. **Консистентность** - единообразный подход с другими страницами (finances)
4. **Производительность** - минимальное количество запросов к API
5. **Адаптивность** - работает на всех устройствах (desktop, tablet, mobile)

## Технические детали

### Обновление статуса

При смене статуса выполняется:
1. Вызов API `updateProject` с новым `status_id`
2. Обновление локального состояния проекта
3. Показ уведомления об успехе/ошибке
4. Обновление счётчика новых проектов в сайдбаре
5. Автоматическое закрытие dropdown

### Обработка ошибок

- При ошибке API показывается toast-уведомление
- Статус остаётся неизменным
- Dropdown автоматически закрывается

### Оптимизация

- Предотвращение множественных одновременных запросов через флаг `isUpdating`
- Закрытие dropdown при клике вне компонента
- Остановка всплытия событий для предотвращения конфликтов

## Совместимость

- ✅ Desktop (полная функциональность)
- ✅ Tablet (полная функциональность)
- ✅ Mobile (полная функциональность)
- ✅ Dark mode (поддерживается)
- ✅ Accessibility (ARIA-атрибуты)

## Будущие улучшения

- [ ] Добавить подтверждение для критичных смен статуса (например, "Отменён")
- [ ] Добавить историю изменений статусов
- [ ] Добавить фильтрацию по статусам с использованием inline компонента
- [ ] Добавить bulk операции для смены статуса нескольких проектов

## Связанные файлы

- `b5-admin/src/lib/components/business-processes/projects/ProjectStatusBadge.svelte`
- `b5-admin/src/lib/components/business-processes/projects/ProjectsTable.svelte`
- `b5-admin/src/routes/(protected)/(business-processes)/projects/+page.svelte`
- `b5-admin/src/lib/api/projects.js`
- `b5-admin/src/lib/index.js`

## Тестирование

### Ручное тестирование

1. Перейти на страницу `/projects`
2. Кликнуть на бейдж статуса любого проекта
3. Выбрать новый статус из выпадающего списка
4. Убедиться, что:
   - Статус обновился в таблице
   - Показалось уведомление об успехе
   - Dropdown закрылся автоматически
   - Счётчик новых проектов обновился (если применимо)

### Проверка на разных устройствах

- Desktop: полная функциональность
- Tablet: горизонтальная прокрутка с dropdown
- Mobile: карточный вид с dropdown

## Примечания

- Функционал доступен всем авторизованным пользователям
- Права доступа контролируются на уровне API
- Компонент использует те же API endpoints, что и модальное окно редактирования
