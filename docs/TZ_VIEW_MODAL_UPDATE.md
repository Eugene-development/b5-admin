# Обновление модального окна просмотра техзадания

## Описание изменений

Добавлены новые карточки с информацией об участниках и клиенте в модальное окно просмотра техзадания (`TzViewModal.svelte`).

## Что изменено

### Добавлено в GraphQL запрос (`technicalSpecifications.js`):
- `project.project_number` - номер проекта
- `project.is_incognito` - флаг инкогнито режима
- `project.curator` - данные куратора через belongsToMany (имя, email, телефоны)
- `project.projectUsers` - все участники проекта с ролями (для резервного получения данных)
- `project.client` - данные клиента (имя, телефоны)

### Добавлены новые карточки в модальное окно:

#### 1. Карточка "Участники"
Отображает информацию об участниках проекта:
- **Куратор**: имя и телефон (всегда отображается)
- **Агент**: имя и телефон (отображается только если проект НЕ в статусе "Инкогнито")

#### 2. Карточка "Клиент"
Отображает информацию о клиенте:
- **Имя**: имя клиента
- **Телефон**: основной телефон клиента (если указан)
- **Адрес**: регион/адрес клиента

### Добавлены вспомогательные функции:
- `getCuratorName()` - получение имени куратора (проверяет curator и projectUsers)
- `getCuratorPhone()` - получение телефона куратора (проверяет curator и projectUsers)
- `getAgentName()` - получение имени агента (проверяет agent и projectUsers)
- `getAgentPhone()` - получение телефона агента (проверяет agent и projectUsers)
- `isIncognito()` - проверка статуса инкогнито
- `getClientName()` - получение имени клиента
- `getClientPhone()` - получение телефона клиента
- `getClientAddress()` - получение адреса клиента

### Восстановлен импорт:
- `formatPhone` из утилит для форматирования телефонных номеров

## Структура модального окна после изменений

### Хэдер:
- Заголовок: название техзадания или `Техзадание #ID`
- Подзаголовок: номер проекта
- Бейджи статуса согласования

### Тело (левая колонка):
1. Карточка "Участники" (куратор + агент, если не инкогнито)
2. Карточка "Клиент" (имя, телефон, адрес)
3. Карточка "Описание" / "Комментарий" (если есть)

### Тело (правая колонка):
1. Карточка "Техзадания" (файлы ТЗ)
2. Карточка "Коммерческие предложения" (файлы КП)

### Футер:
- Даты создания и обновления
- Кнопка "Закрыть"

## Логика отображения агента

Агент отображается в карточке "Участники" только если:
- Проект НЕ находится в статусе "Инкогнито" (`is_incognito !== true`)

Это позволяет скрывать информацию об агенте в конфиденциальных проектах.

## Получение данных куратора

Куратор может быть связан с проектом двумя способами:
1. Через связь `curator` (belongsToMany в таблице `project_user` с ролью `curator`)
2. Через связь `projectUsers` с ролью `curator`

Функции `getCuratorName()` и `getCuratorPhone()` проверяют оба источника данных для максимальной надежности.

## Проверка данных в базе

Для проверки наличия кураторов в проектах используйте скрипт:

```bash
cd b5-api-2
php check-curator-data.php
```

Скрипт покажет:
- Список проектов с техзаданиями
- Наличие записей в таблице `project_user`
- Статистику по проектам с/без кураторов

## Возможные проблемы

### Куратор не отображается

**Причины:**
1. В таблице `project_user` нет записи с ролью `curator` для данного проекта
2. Связь `curator` в модели Project не возвращает данные

**Решение:**
1. Проверьте данные в базе с помощью скрипта `check-curator-data.php`
2. Убедитесь, что в таблице `project_user` есть запись с `role = 'curator'`
3. Проверьте, что у пользователя-куратора заполнены имя и телефоны

## Файлы

- `b5-admin/src/lib/components/business-processes/tz/TzViewModal.svelte`
- `b5-admin/src/lib/api/technicalSpecifications.js`
- `b5-api-2/check-curator-data.php` (новый скрипт для диагностики)

## Тестирование

1. Открыть страницу Техзадания в b5-admin
2. Нажать на кнопку "Просмотр" любого техзадания
3. Проверить, что отображаются:
   - Карточка "Участники" с куратором
   - Агент в карточке "Участники" (если проект не в режиме инкогнито)
   - Карточка "Клиент" с именем, телефоном и адресом
   - Телефоны отображаются как кликабельные ссылки
   - Телефоны отформатированы корректно
4. Проверить проект в режиме инкогнито - агент не должен отображаться
5. Если куратор не отображается - запустить скрипт диагностики
