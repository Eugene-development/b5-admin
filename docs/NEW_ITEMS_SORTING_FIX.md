# Исправление сортировки новых элементов

## Дата: 5 декабря 2025

## Проблема

При добавлении новых элементов на различных страницах приложения, новый элемент сначала отображался в начале списка (что правильно), но после обновления данных или перезагрузки страницы оказывался в конце списка.

Это происходило потому, что:
1. При создании элемента он добавлялся в начало локального массива
2. При обновлении данных с сервера элементы приходили в порядке, определяемом API (обычно старые первыми)
3. Отсутствовала сортировка по дате создания в серверных загрузчиках данных

## Решение

Добавлена сортировка по полю `created_at` в порядке убывания (новые элементы первыми) во всех серверных загрузчиках данных (`+page.server.js`).

## Исправленные страницы

### Бизнес-процессы

#### 1. Акции (`/actions`)
**Файл:** `b5-admin/src/routes/(protected)/(business-processes)/actions/+page.server.js`

**Изменения:**
```javascript
// Добавлена сортировка перед трансформацией данных
const sortedActions = [...rawActions].sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
    return dateB - dateA;
});
```

#### 2. Рекламации (`/complaints`)
**Файл:** `b5-admin/src/routes/(protected)/(business-processes)/complaints/+page.server.js`

**Изменения:**
```javascript
// Добавлена сортировка после получения данных
const complaints = [...rawComplaints].sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
    return dateB - dateA;
});
```

#### 3. Закупки (`/order`)
**Файл:** `b5-admin/src/routes/(protected)/(business-processes)/order/+page.server.js`

**Изменения:**
```javascript
// Добавлена сортировка после получения данных
const orders = [...rawOrders].sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
    return dateB - dateA;
});
```

#### 4. Техзадания (`/tz`)
**Файл:** `b5-admin/src/routes/(protected)/(business-processes)/tz/+page.server.js`

**Изменения:**
```javascript
// Добавлена сортировка после получения данных
const tzList = [...rawTzList].sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
    return dateB - dateA;
});
```

### Страницы, которые уже были исправлены ранее

#### Бизнес-процессы
- **Контракты** (`/contracts`) - уже имел сортировку
- **Проекты** (`/projects`) - уже имел сортировку (строки 127-132)

#### Контрагенты
Все страницы контрагентов уже имели сортировку:
- **Поставщики** (`/suppliers`)
- **Подрядчики** (`/contractors`)
- **Сервисные компании** (`/services`)
- **Доставка** (`/delivery`)

#### Менеджмент
- **Клиенты** (`/clients`) - использует функцию `addSequentialNumbers()`, которая автоматически сортирует
- **Агенты** (`/agents`) - уже имел сортировку (строка 57)
- **Кураторы** (`/curators`) - используют общую логику с агентами
- **Дизайнеры** (`/designers`) - используют общую логику с агентами
- **Менеджеры** (`/managers`) - используют общую логику с агентами

## Техническая реализация

### Паттерн сортировки

Во всех исправленных файлах используется единый паттерн:

```javascript
const sortedItems = [...rawItems].sort((a, b) => {
    const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
    const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
    return dateB - dateA; // Descending order (newest first)
});
```

### Особенности

1. **Создание копии массива** (`[...rawItems]`) - предотвращает мутацию исходных данных
2. **Обработка отсутствующих дат** - если `created_at` отсутствует, используется `new Date(0)` (1 января 1970)
3. **Порядок убывания** - `dateB - dateA` обеспечивает отображение новых элементов первыми

## Преимущества

1. **Консистентность** - элементы всегда отображаются в одном порядке
2. **Предсказуемость** - новые элементы всегда появляются вверху списка
3. **UX** - пользователь сразу видит только что созданный элемент
4. **Единообразие** - все страницы используют одинаковую логику сортировки

## Тестирование

Для проверки исправления:

1. Откройте любую из исправленных страниц
2. Добавьте новый элемент
3. Убедитесь, что он появился в начале списка
4. Обновите страницу (F5)
5. Убедитесь, что элемент остался в начале списка

## Связанные файлы

- `b5-admin/src/lib/utils/sequentialNumber.js` - утилита для добавления порядковых номеров с сортировкой
- `b5-admin/src/routes/(protected)/(business-processes)/contracts/+page.svelte` - пример правильной реализации на клиенте

## Примечания

- Сортировка выполняется на сервере при загрузке данных (SSR)
- Клиентская часть также добавляет новые элементы в начало массива для мгновенного отображения
- При обновлении данных серверная сортировка обеспечивает правильный порядок
