# Тестирование функции выхода из системы

## Шаги для тестирования

### 1. Подготовка
1. Откройте DevTools браузера (F12)
2. Перейдите на вкладку "Application" → "Cookies"
3. Найдите cookie `b5_auth_2_session`

### 2. Тест 1: Выход через сайдбар
1. Войдите в систему
2. Проверьте наличие cookie `b5_auth_2_session` в DevTools
3. Нажмите кнопку "Выйти" в сайдбаре
4. Подтвердите выход в модальном окне
5. **Ожидаемый результат:**
   - Редирект на `/login`
   - Cookie `b5_auth_2_session` удален
   - В консоли браузера нет ошибок

### 3. Тест 2: Попытка доступа к главной странице после выхода
1. После выхода (из Теста 1) удалите `/login` из URL
2. Нажмите Enter (перейдите на `/`)
3. **Ожидаемый результат:**
   - Остаетесь на главной странице `/`
   - НЕ перебрасывает на `/dashboard`
   - Видны кнопки "Логин" и "Регистрация"

### 4. Тест 3: Попытка доступа к защищенным страницам
1. После выхода попробуйте перейти на `/dashboard`
2. **Ожидаемый результат:**
   - Редирект на `/login`
   - Cookie отсутствует

### 5. Тест 4: Выход через страницу профиля
1. Войдите в систему снова
2. Перейдите на страницу `/profile`
3. Нажмите кнопку "Выйти из системы"
4. Подтвердите выход
5. **Ожидаемый результат:**
   - Редирект на `/`
   - Cookie удален
   - Остаетесь на главной странице

### 6. Проверка логов (опционально)
Если проблема сохраняется, проверьте логи Laravel:

```bash
cd b5-auth-2
tail -f storage/logs/laravel.log
```

Ищите записи:
- `Logout initiated`
- `Session invalidated and token regenerated`
- `Cookie config`

## Возможные проблемы и решения

### Проблема: Cookie не удаляется на localhost
**Причина:** На localhost cookie с `domain=null` ведут себя иначе, чем на production

**Решение (уже реализовано):**
В `AuthController::logout()` добавлена специальная обработка для localhost:
- Для localhost: `domain=null` (не устанавливается)
- Для production: используется `SESSION_DOMAIN` из конфигурации

**Проверка:**
1. Откройте DevTools → Application → Cookies
2. Найдите cookie `b5_auth_2_session`
3. Проверьте поле "Domain":
   - На localhost должно быть пусто или "localhost"
   - На production должен быть ваш домен

### Проблема: Cookie не удаляется на production
**Причина:** Несоответствие domain/path при удалении cookie

**Решение:**
1. Проверьте `.env` в `b5-auth-2`:
   ```
   SESSION_DOMAIN=null
   SESSION_PATH=/
   SESSION_COOKIE=b5_auth_2_session
   ```

2. Убедитесь, что в DevTools cookie имеет:
   - Domain: ваш домен (например, .bonus.band)
   - Path: /

### Проблема: Перебрасывает на dashboard после выхода
**Причина:** Cookie все еще присутствует или authState не обновился

**Решение:**
1. Проверьте в DevTools, что cookie действительно удален
2. Проверьте консоль браузера на наличие ошибок
3. Проверьте Network tab - запрос к `/api/user` должен возвращать 401

### Проблема: Ошибка CORS
**Причина:** Неправильная конфигурация CORS

**Решение:**
Проверьте `b5-auth-2/config/cors.php`:
```php
'supports_credentials' => true,
```

## Дополнительная отладка

### Проверка cookie в браузере
Откройте консоль браузера и выполните:
```javascript
document.cookie.split(';').forEach(c => console.log(c.trim()));
```

### Проверка authState
В консоли браузера:
```javascript
// Если используете Svelte DevTools
$authState
```

### Ручное удаление cookie (для тестирования)
В консоли браузера:
```javascript
document.cookie = 'b5_auth_2_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
```
