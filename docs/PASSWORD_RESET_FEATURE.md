# Функционал восстановления пароля для B5-Admin

## Описание

Реализован полный функционал восстановления пароля для административной панели b5-admin с использованием бэкенда b5-auth-2.

## Сценарий работы

### 1. Запрос на восстановление пароля

- Администратор переходит на страницу `/forgot-password`
- Вводит свой email
- Нажимает "Отправить ссылку"
- На email отправляется письмо со ссылкой для сброса пароля

### 2. Сброс пароля

- Администратор переходит по ссылке из письма
- Открывается страница `/reset-password` с токеном и email в URL
- Администратор вводит новый пароль и подтверждение
- После успешного сброса автоматически перенаправляется на страницу `/login`

## Реализованные компоненты

### Фронтенд (b5-admin)

#### 1. API функции (src/lib/api/auth.js)

**forgotPassword(email)**

- Отправляет запрос на восстановление пароля
- Endpoint: `/api/forgot-password`
- Обработка ошибок с понятными сообщениями на русском

**resetPassword(token, email, password, password_confirmation)**

- Сбрасывает пароль по токену
- Endpoint: `/api/reset-password`
- Валидация и обработка ошибок

#### 2. Конфигурация (src/lib/api/config.js)

Добавлены endpoints:

```javascript
forgotPassword: '/api/forgot-password',
resetPassword: '/api/reset-password'
```

#### 3. Страницы

**`/forgot-password`**

- Форма запроса восстановления пароля
- Валидация email
- Отображение успешной отправки
- Ссылка возврата на страницу входа
- Единый дизайн с другими auth страницами

**`/reset-password`**

- Форма сброса пароля
- Получение токена и email из URL
- Валидация паролей (минимум 8 символов, совпадение)
- Автоматический редирект на /login после успешного сброса
- Единый дизайн с другими auth страницами

#### 4. Интеграция с login

Ссылка "Забыли пароль?" уже присутствует на странице `/login`

### Бэкенд (b5-auth-2)

Используется общий бэкенд для всех фронтендов:

- AuthController с методами `forgotPassword()` и `resetPassword()`
- ResetPasswordNotification для отправки email
- Мультидоменность: ссылка формируется с учетом `registration_domain`
- CSRF исключение для роутов восстановления пароля

## Дизайн

Страницы выполнены в едином стиле с другими auth страницами b5-admin:

- Темная тема с градиентами
- Стеклянный морфизм эффект
- Адаптивный дизайн
- Анимации и transitions
- Иконки и визуальные подсказки

## Безопасность

1. **Throttling**: Ограничение на 3 запроса в минуту для forgot-password
2. **Токен**: Генерируется случайный токен длиной 64 символа
3. **Хеширование**: Токен хешируется перед сохранением в БД
4. **Срок действия**: Токен действителен 60 минут
5. **Удаление токена**: После успешного сброса токен удаляется
6. **Безопасный ответ**: Даже если email не существует, возвращается успешный ответ
7. **CSRF исключение**: Роуты восстановления пароля исключены из CSRF защиты

## Мультидоменность

Ссылка в письме автоматически формируется с учетом домена регистрации администратора:

- Если админ зарегистрирован через `admin.bonus.band` → ссылка ведет на `admin.bonus.band/reset-password`
- Fallback на `FRONTEND_URL` если домен не указан

## Тестирование

### Локальное тестирование

1. **Запустите бэкенд:**

```bash
cd b5-auth-2
php artisan serve --port=8001
```

2. **Запустите фронтенд:**

```bash
cd b5-admin
npm run dev
```

3. **Откройте страницу:**

```
http://localhost:5173/forgot-password
```

4. **Проверьте письмо:**

- Если `MAIL_MAILER=log`: смотрите `b5-auth-2/storage/logs/laravel.log`
- Если Mailtrap: проверьте inbox

### Проверка функционала

- ✅ Форма forgot-password отправляется без ошибок
- ✅ Письмо приходит с правильной ссылкой
- ✅ Ссылка открывает форму reset-password
- ✅ Email предзаполнен в форме
- ✅ Новый пароль успешно сохраняется
- ✅ Редирект на /login после успешного сброса
- ✅ Вход с новым паролем работает

## API Endpoints

### Forgot Password

```
POST /api/forgot-password
Content-Type: application/json

{
  "email": "admin@example.com"
}

Response:
{
  "success": true,
  "message": "Ссылка для сброса пароля отправлена на ваш email"
}
```

### Reset Password

```
POST /api/reset-password
Content-Type: application/json

{
  "token": "...",
  "email": "admin@example.com",
  "password": "newpassword123",
  "password_confirmation": "newpassword123"
}

Response:
{
  "success": true,
  "message": "Пароль успешно изменен"
}
```

## Обработка ошибок

### Forgot Password

- 422: Некорректный email
- 429: Слишком много запросов
- 0: Сетевая ошибка

### Reset Password

- 422: Некорректные данные (пароль, подтверждение)
- 400: Недействительный или истекший токен
- 404: Пользователь не найден
- 0: Сетевая ошибка

## Возможные улучшения

1. Добавить капчу для защиты от спама
2. Добавить историю изменений паролей
3. Уведомление на email при успешной смене пароля
4. Возможность отмены запроса на сброс пароля
5. Показ времени истечения токена на странице сброса
6. Двухфакторная аутентификация при сбросе пароля

## Связанные файлы

### Фронтенд (b5-admin)

- `src/lib/api/auth.js` - API функции
- `src/lib/api/config.js` - Конфигурация endpoints
- `src/routes/(auth)/forgot-password/+page.svelte` - Страница запроса
- `src/routes/(auth)/reset-password/+page.svelte` - Страница сброса
- `src/routes/(auth)/login/+page.svelte` - Ссылка "Забыли пароль?"

### Бэкенд (b5-auth-2)

- `app/Http/Controllers/AuthController.php` - Контроллер
- `app/Notifications/ResetPasswordNotification.php` - Email уведомление
- `resources/views/emails/reset-password-russian.blade.php` - Шаблон письма
- `routes/api.php` - API роуты
- `bootstrap/app.php` - CSRF исключения

### База данных (b5-db-2)

- `database/migrations/0001_01_01_000000_create_users_table.php` - Таблица password_reset_tokens
